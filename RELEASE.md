# *Product Model - Cashflow Generation for Settlement Payout*

_Background_

This release contains changes required to enable the generation of cashflows from a simple settlement payout. This change allows FX transactions, which are now represented using a settlement payout, still to be viewed as two legs for downstream reporting purposes in DRR.

Further background is detailed in Issue: [#3269](https://github.com/finos/common-domain-model/issues/3269)

_What is being released?_

This release includes core modifications to the `Cashflow` type, so that it can be generated by a settlement payout and used to represent the two legs of an FX transaction. Because a settlement payout can take any sort of asset as underlyer, the generated cashflows can in fact represent the transfers of any asset and not just cash as in an FX transaction.

Changes are therefore brought to the `Cashflow` type to accomodate any type of asset. Because that type becomes closely aligned functionally to the `Transfer` type, the two types have been harmonised to extend a common ancestor: `AssetFlowBase`, which defines the what (asset), how much (quantity > 0) and when (settlement date) of an asset transfer. The "AssetFlowBase" name is generalising the term "cash" in "cashflow" to any "asset", whereas the `Cashflow` type retains its original name to minimise downstream impact.

A new function: `Create_CashflowFromSettlementPayout`, takes a single `SettlementPayout` and returns the two `Cashflow` implied by this payout. The two cashflow legs are called `assetLeg` and `priceLeg`, respectively. The function works generically regardless of the type of asset used as underlyer in the `SettlementPayout` and `assetLeg`. The `priceLeg` always consists of cash, whose amount and currency are implied by the price and quantity parameters of the settlement payout.

Finally, the `Cashflow` choice is being removed from `Payout` as it is no longer used there.

Accordingly, this release includes the following changes:

**Types and attributes**

- New type:
  - `AssetFlowBase`, in `product.common.settlement`, that provides the common ancestor to harmonise `Cashflow` and `Transfer`
  - Its attributes are aligned onto the former `TransferBase` ones and are all mandatory:
    - `asset` as `Asset`
    - `quantity` as `NonNegativeQuantity`
    - `settlementDate` as `AdjustableOrAdjustedOrRelativeDate`

- Modification to existing types:
  - Both `Cashflow` (previously extending `PayoutBase`) and `Transfer` (previously extending `TransferBase`) extend `AssetFlowBase`
  - `Transfer` is unchanged as a result of this change, i.e. it has the same attributes as before
  - `Cashflow` no longer has the following irrelevant attributes previously inherited from `PayoutBase`:
    - `principalPayment`
    - `settlementTerms`, replaced by `settlementDate` only
    - `priceQuantity`, replaced by `asset` and `quantity` only

- Deletions:
  - `TransferBase` has been deleted
  - `Cashflow` is no longer a choice of `Payout`

**Validation rules**

- `EconomicTerms`: Rules that rely on the presence of `Cashflow` for certain CDS transactions are no longer relevant. In cases where the fee leg includes a stand-alone cashflow payment, it is already represented by a `Transfer` in the transaction event.
  - `FpML_cd_26_28`
  - `FpML_cd_27`

**Functions**

- New function:
  - `Create_CashflowFromSettlementPayout`

- Modification to existing function:
  - `Create_OnDemandInterestPaymentPrimitiveInstruction` has been modified to include a `transfer` instead of a `termsChange` primitive (the latter previously featured an additional `Cashflow` in the payout).

- Deletions:
  - `Create_CashflowTermsChangeInstruction`: no longer used
  - `Create_Cashflow`: no longer used

_Backward incompatible changes_

Most changes in this release are backward-incompatible, with some types and functions being deleted or their attributes modified.

The most consequential change is to the `Cashflow` type and the fact that it has been removed from the `Payout` choice. However, no sample illustrates this change because practically this component was no longer being used as a payout.

`Transfer` remains unchanged.

_Review Directions_

Please inspect the changes identified above for the functions and types in the Textual Viewer Rosetta.

The changes can also be reviewed in PR: [#3290](https://github.com/finos/common-domain-model/pull/3290).
