namespace org.isda.cdm
version "${project.version}"

import cdm.base.staticdata.party.*

import cdm.observable.asset.*

import cdm.product.template.*

import cdm.legalagreement.csa.*
import cdm.legalagreement.common.*
import cdm.legalagreement.contract.*

import cdm.event.common.*
import cdm.event.workflow.*

body Authority ESMA <"ESMA is an independent EU Authority that contributes to safeguarding the stability of the European Union's financial system by enhancing the protection of investors and promoting stable and orderly financial markets.">
body Authority FCA <"The Financial Conduct Authority is the conduct regulator for 58,000 financial services firms and financial markets in the UK and the prudential regulator for over 18,000 of those firms. ">
body Organisation ISDA <"Since 1985, the International Swaps and Derivatives Association has worked to make the global derivatives markets safer and more efficient">

corpus Regulation "600/2014" MiFIR
	<"Regulation (EU) No 600/2014 of the European Parliament and of the Council of 15 May 2014 on markets in financial instruments and amending Regulation (EU) No 648/2012 Text with EEA relevance">

corpus Regulation "648/2012" EMIR
	<"Regulation (EU) No 648/2012 of the European Parliament and of the Council of 4 July 2012 on OTC derivatives, central counterparties and trade repositories Text with EEA relevance">

corpus CommissionDelegatedRegulation "2017/590" RTS_22
	 <"Commission Delegated Regulation (EU) 2017/590 of 28 July 2016 supplementing Regulation (EU) No 600/2014 of the European Parliament and of the Council with regard to regulatory technical standards for the reporting of transactions to competent authorities (Text with EEA relevance. )">

corpus CommissionDelegatedRegulation "148/2013" ITS_9
	<"Commission Delegated Regulation (EU) No 148/2013 of 19 December 2012 supplementing Regulation (EU) No 648/2012 of the European Parliament and of the Council on OTC derivatives, central counterparties and trade repositories with regard to regulatory technical standards on the minimum details of the data to be reported to trade repositories Text with EEA relevance">

corpus ESMA_Q_and_A "09April 2019|ESMA70-1861941480-56" Q_AND_A_MiFIR_DATA_REPORTING
	<"The purpose of this document is to promote common supervisory approaches and practices in the application of MiFID II and MiFIR in relation to regulatory data reporting topics. It provides responses to questions posed by the general public, market participants and competent authorities in relation to the practical application of MiFID II and MiFIR.">

corpus ReportingStandard "ISO 20022" ISO_20022
	<"ISO 20022 is a multi part International Standard prepared by ISO Technical Committee TC68 Financial Services.">

segment rationale
segment rationale_author
segment structured_provision

segment article
segment whereas
segment annex
segment table
segment section
segment field
segment paragraph
segment question

report ESMA MiFIR RTS_22 in T+1
	when MifirInvestmentFirm and ReportableTransaction and ReportableProduct
	using standard ISO_20022 with fields
		ReportStatus
		TransactionReferenceNumber
		TradingVenueTransactionIdentificationCode
		ExecutingEntityIdentificationCode
		IsInvestmentFirm
		SubmittingEntityIdentificationCode
		BuyerSeller
		TransmissionOfOrderIndicator
		TradingDateTime
		TradingCapacity
		Quantity
		Price
		VenueOfExecution
		CountryOfTheBranchMembership
		InstrumentIdentificationCode
		InstrumentFullName
		InstrumentClassification
		NotionalCurrency1
		NotionalCurrency2
		PriceMultiplier
		UnderlyingInstrumentCode
		UnderlyingIndexName
		UnderlyingIndexTermPeriod
		UnderlyingIndexTermMultiplier
		ExpiryDate
		DeliveryType
		InvestmentDecisionWithinFirm
		PersonResponsibleForInvestmentDecisionCountry
		ExecutionWithinFirm
		PersonResponsibleForExecutionCountry
		CommodityDerivativeIndicator
		SecuritiesFinancingTransactionIndicator

report ESMA EMIR ITS_9 in T+1
	when EmirInvestmentFirm
	using standard ISO_20022 with fields
		
		ReportingCounterpartyID
		BuyerSeller 
  		MaturityDate 
		Price

eligibility rule ReportableProduct <"When eligible for rts 22">
	[regulatoryReference ESMA MiFIR RTS_22 article "26" paragraph "2"
   		provision "The obligation laid down in paragraph 1 shall apply to: (a) financial instruments which are admitted to trading or traded on a trading venue or for which a request for admission to trading has been made; (b) financial instruments where the underlying is a financial instrument traded on a trading venue; and(c) financial instruments where the underlying is an index or a basket composed of financial instruments traded on a trading venue The obligation shall apply to transactions in financial instruments referred to in points (a) to (c) irrespective of whether or not such transactions are carried out on the trading venue."]
		filter when rule HasContract

eligibility rule HasContract <"When eligible for rts 22">
	[regulatoryReference ESMA MiFIR RTS_22 article "2"
   		provision "For the purposes of Article 26 of Regulation (EU) No 600/2014, the conclusion of an acquisition or disposal of a financial instrument referred to in Article 26(2) of Regulation (EU) No 600/2014 shall constitute a transaction."]
		TradeForEvent then
		extract Trade -> tradableProduct -> product -> contractualProduct exists

eligibility rule ReportableTransaction <"When eligible for rts 22">
	[regulatoryReference ESMA MiFIR RTS_22 article "26"
	provision "For the purposes of Article 26 of Regulation (EU) No 600/2014, the conclusion of an acquisition or disposal of a financial instrument referred to in Article 26(2) of Regulation (EU) No 600/2014 shall constitute a transaction."]
		(NewTrade, QuantityChange)

eligibility rule NewTrade
	[regulatoryReference ESMA MiFIR RTS_22 article "26" paragraph "2"
		provision "An acquisition referred to in paragraph 1 shall include the following:  (b) entering into a derivative contract; (c) an increase in the notional amount of a derivative contract. 5. A transaction for the purposes of Article 26 of Regulation (EU) No 600/2014 shall not include the following:  (b) a contract arising exclusively for clearing or settlement purposes; (c) a settlement of mutual obligations between parties where the net obligation is carried forward;  (e) a post-trade assignment or novation of a derivative contract where one of the parties to the derivative contract is replaced by a third party (f) a portfolio compression;  (h) the exercise of a right embedded in a financial instrument, or the conversion of a convertible bond and the resultant transaction in the underlying financial instrument; (i) the creation, expiration or redemption of a financial instrument as a result of pre-determined contractual terms, or as a result of mandatory events which are beyond the control of the investor where no investment decision by the investor takes place at the point in time of the creation, expiration or redemption of the financial instrument; (j) a decrease or increase in the notional amount of a derivative contract as a result of pre-determined contractual terms or mandatory events where no investment decision by the investor takes place at the point in time of the change in the notional amount; (k) a change in the composition of an index or a basket that occurs after the execution of a transaction;  "]
		(
			filter when WorkflowStep -> businessEvent -> primitives -> execution exists,
			filter when (WorkflowStep -> businessEvent -> primitives -> contractFormation exists and WorkflowStep -> businessEvent -> primitives -> contractFormation -> after only exists)
		)

eligibility rule QuantityChange
	[regulatoryReference ESMA MiFIR RTS_22 article "26" paragraph "2"
		structured_provision "A business event that contains a quantityChange primitive must be reported if the business event is in {Increase, partialTermination, Termination}"
		provision " An acquisition referred to in paragraph 1 shall include the following:  (c) an increase in the notional amount of a derivative contract. 3. A disposal referred to in paragraph 1 shall include the following:  (b) closing out of a derivative contract; (c) a decrease in the notional amount of a derivative 5. A transaction for the purposes of Article 26 of Regulation (EU) No 600/2014 shall not include the following:  (e) a post-trade assignment or novation of a derivative contract where one of the parties to the derivative contract is replaced by a third party (f) a portfolio compression;  (h) the exercise of a right embedded in a financial instrument, or the conversion of a convertible bond and the resultant transaction in the underlying financial instrument; (i) the creation, expiration or redemption of a financial instrument as a result of pre-determined contractual terms, or as a result of mandatory events which are beyond the control of the investor where no investment decision by the investor takes place at the point in time of the creation, expiration or redemption of the financial instrument; (j) a decrease or increase in the notional amount of a derivative contract as a result of pre-determined contractual terms or mandatory events where no investment decision by the investor takes place at the point in time of the change in the notional amount; (k) a change in the composition of an index or a basket that occurs after the execution of a transaction; "]
	filter when WorkflowStep -> businessEvent -> primitives -> quantityChange exists

eligibility rule MifirInvestmentFirm <"Identify as an investment firm which has executed the trade">
	[regulatoryReference ESMA MiFIR RTS_22 section "Context of the Delegation Act"
	   	provision "The Markets in Financial Instruments Regulation (EU) No 600/2014 (MiFIR) requires investment firms to report complete and accurate details of transactions in financial instruments. 'investment firm’ means any legal person whose regular occupation or business is the provision of one or more investment services to third parties and/or the performance of one or more investment activities on a professional basis. Member States may include in the definition of investment firms undertakings which are not legal persons, provided that: (a) their legal status ensures a level of protection for third parties’ interests equivalent to that afforded by legal persons; and (b) they are subject to equivalent prudential supervision appropriate to their legal form. However, where a natural person provides services involving the holding of third party funds or transferable securities, that person may be considered to be an investment firm for the purposes of this Directive and of Regulation (EU) No 600/2014 only if, without prejudice to the other requirements imposed in this Directive, in Regulation (EU) No 600/2014, and in Directive 2013/36/EU, that person complies with the following conditions: (a) the ownership rights of third parties in instruments and funds must be safeguarded, especially in the event of the insolvency of the firm or of its proprietors, seizure, set-off or any other action by creditors of the firm or of its proprietors; (b) the firm must be subject to rules designed to monitor the firm’s solvency and that of its proprietors; (c) the firm’s annual accounts must be audited by one or more persons empowered, under national law, to audit accounts; (d) where the firm has only one proprietor, that person must make provision for the protection of investors in the event of the firm’s cessation of business following the proprietor’s death or incapacity or any other such event"]
		filter when rule IsExecutingEntityInvestmentFirm then
	    filter when rule BranchInEU

eligibility rule EmirInvestmentFirm <"Identify as an investment firm which has executed the trade">
	[regulatoryReference ESMA EMIR ITS_9 article "1 (2)"
   		provision "This Regulation shall apply to CCPs and their clearing members, to financial counterparties and to trade repositories. It shall apply to non-financial counterparties and trading venues where so provided"]
			filter when rule CountryOfIncorporationInEEA

eligibility rule BranchInEU
		TradeForEvent then
			ExecutingEntityForReportingParty then
			 extract ExecutingEntity -> addressOfBranch then
			IsAddressInEU

eligibility rule CountryOfIncorporationInEU
		TradeForEvent then
			ExecutingEntityForReportingParty then
			 extract ExecutingEntity -> addressOfIncorporation then
			IsAddressInEU

eligibility rule BranchInEEA
		TradeForEvent then
			ExecutingEntityForReportingParty then
			 extract ExecutingEntity -> addressOfBranch then
			IsAddressInEEA

eligibility rule CountryOfIncorporationInEEA
		TradeForEvent then
			ExecutingEntityForReportingParty then
			 extract ExecutingEntity -> addressOfIncorporation then
			IsAddressInEEA

eligibility rule IsExecutingEntityInvestmentFirm
		TradeForEvent then
		ExecutingEntityForReportingParty then
		extract ExecutingEntity -> isInvestmentFirm

eligibility rule ExecutingEntityForReportingParty
			extract Trade -> contractDetails -> partyContractInformation then
			filter when PartyContractInformation -> relatedParty -> role = PartyRoleEnum -> ReportingParty then
			extract PartyContractInformation -> partyReference then
			lookup ExecutingEntity ExecutingEntity

reporting rule MaturityDate <"Date of maturity of the financial instrument. Field only applies to debt instruments with defined maturity">
	[regulatoryReference ESMA MiFIR RTS_22 annex "1. Table 2. Field 54"
		provision "Date of maturity of the financial instrument. Field only applies to debt instruments with defined maturity."]
	[regulatoryReference ESMA EMIR ITS_9 field "2.27"
		provision "Original date of expiry of the reported contract.  An early termination shall not be reported in this field."]
 	TradeForEvent then extract Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> terminationDate -> adjustableDate -> unadjustedDate

reporting rule ReportingCounterpartyID
	[regulatoryReference ESMA EMIR ITS_9 field "1.2"
 	   	provision "Unique code identifying the reporting counterparty of the contract (the LEI)"]
 	TradeForEvent then
	 	extract Trade -> contractDetails -> partyContractInformation then
			filter when PartyContractInformation -> relatedParty -> role = PartyRoleEnum -> ReportingParty then
			extract PartyContractInformation -> partyReference -> partyId
			as "Reporting Counterparty ID"

reporting rule ReportStatus <"Indication as to whether the transaction report is new or a cancellation">
	[regulatoryReference ESMA MiFIR RTS_22
			annex "I" table "2" field "1"
			provision "Indication as to whether the transaction report is new or a cancellation."]
	[regulatoryReference ESMA MiFIR RTS_22
			article "2"
			rationale_author "DRR"
			rationale "Article 2 means that each reportable event is treated as an independent transaction. The practical implementation of corrections is: A New event is a NEWT, A new, non-reportable version of a previously-reported event, that renders the previous version of the same event non-reportable, is a CANC, A new, non-reportable version of a non-reportable event is not reported, A new, reportable version of a previously-reported event, that supersedes the previous version of the same event is a CANC followed by a NEWT"
			structured_provision "MiFIR.ReportStatus is by definition 'NEWT’ unless the report is a Cancellation when MiFIR.ReportStatus is by definition 'CANC’"
			provision "Indication as to whether the transaction report is new or a cancellation."]
 	extract if WorkflowStep -> businessEvent -> primitives -> execution exists
 				or WorkflowStep -> businessEvent -> primitives -> contractFormation exists
 				or WorkflowStep -> businessEvent -> primitives -> quantityChange exists
		then "NEWT"
			else if WorkflowStep -> action = ActionEnum -> Cancel
				then "CANC"
				else if WorkflowStep -> businessEvent -> eventQualifier = "Termination"
					then "CANC"
					else ""
		 			as "Report Status"

reporting rule TransactionReferenceNumber
		[regulatoryReference ESMA MiFIR RTS_22
			annex "I" table "2" field "2"
			provision "Identification number that is unique to the executing firm for each transaction report. Where, pursuant to Article 26(5) of Regulation (EU) No 600/2014, a trading venue submits a transaction report on behalf of a firm that is not subject to Regulation (EU) No 600/2014, the trading venue shall populate this field with a number that has been internally generated by the trading venue and that is unique for each transaction report submitted by the trading venue"]
		[regulatoryReference ESMA EMIR ITS_9 field "2.12"
 	   		provision "Until global UTI is available, a Unique Trade ID agreed with the other counterparty"]
		extract WorkflowStep -> eventIdentifier -> assignedIdentifier -> identifier
 			as "Transaction Reference Number"

reporting rule TradingVenueTransactionIdentificationCode <"Trading venue transaction identification code">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "3"
			provision "This is a number generated by trading venues and disseminated to both the buying and the selling parties in accordance with Article 12 of Commission Delegated Regulation (EU) 2017/580"
		]
 	TradeForEvent then
	 	extract Trade -> tradeIdentifier -> assignedIdentifier -> identifier
 		as "Trading Venue Transaction Identification Code"

reporting rule ExecutingEntityIdentificationCode <"Code used to identify the entity executing the transaction (the LEI)">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "4"
		   	provision "Code used to identify the entity executing the transaction."]
			TradeForEvent then
			extract Trade -> contractDetails -> partyContractInformation then
			filter when PartyContractInformation -> relatedParty -> role = PartyRoleEnum -> ReportingParty then
			extract PartyContractInformation -> partyReference then
			extract Party -> partyId

 		as "Executing Entity Identification Code"

reporting rule IsInvestmentFirm
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "5"
			provision "Indicates whether the entity identified in field 4 is an investment firm covered by Article 4(1) of Directive 2014/65/EU."
		]
	 	return "Y"
			as "Is Investment Firm"

reporting rule SubmittingEntityIdentificationCode <"Submitting entity identification code">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "2"
			provision "Code used to identify the entity submitting the transaction report to the competent authority in accordance with Article 26(7) of Regulation (EU) No 600/2014. Where the report is submitted by the executing firm directly to the competent authority, it shall be populated with the LEI of the executing firm (where the executing firm is a legal entity). Where the report is submitted by a trading venue, it shall be populated with the LEI of the operator of the trading venue. Where the report is submitted by an ARM, it shall be populated with the LEI of the ARM."
		]
 	TradeForEvent then
 	extract Trade -> contractDetails -> partyContractInformation then
 	filter when PartyContractInformation -> relatedParty -> role = PartyRoleEnum -> ReportingParty then
 	extract PartyContractInformation -> partyReference -> partyId
 		as "Submitting Entity Identification Code"

reporting rule TransmissionOfOrderIndicator <"Transmission of order indicator">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "25"
			provision "'true’ shall be populated by the transmitting firm within the transmitting firm's report where the conditions for transmission specified in Article 4 were not satisfied 'false’ – in all other circumstances"
		]
 	return "Out Of Scope"
 		as "Transmission Of Order Indicator"

reporting rule TradingDateTime <"Trading date time">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "28"
			provision "Date and time when the transaction was executed. For transactions executed on a trading venue, the level of granularity shall be in accordance with the requirements set out in Article of Commission Delegated Regulation (EU) 2017/574 (2). For transactions not executed on a trading venue, the date and time shall be when the parties agree the content of the following fields: quantity, price, currencies in fields 31, 34 and 44, instrument identification code, instrument classification and underlying instrument code, where applicable. For transactions not executed on a trading venue the time reported shall be at least to the nearest second. Where the transaction results from an order transmitted by the executing firm on behalf of a client to a third party where the conditions for transmission set out in Article 4 were not satisfied, this shall be the date and time of the transaction rather than the time of the order transmission."]
 	extract WorkflowStep -> timestamp then
 		filter when EventTimestamp -> qualification = EventTimestampQualificationEnum -> executionDateTime then
 		extract EventTimestamp -> dateTime
 		as "Trading Date Time"

reporting rule TradingCapacity <"Trading capacity">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "29"
			provision "Indication of whether the transaction results from the executing firm carrying out matched principal trading under Article 4(1)(38) of Directive 2014/65/EU or dealing on own account under Article 4(1)(6) of Directive 2014/65/EU. Where the transaction does not result from the executing firm carrying out matched principal trading or dealing on own account, the field shall indicate that the transaction was carried out under any other capacity."]
		[regulatoryReference ESMA EMIR ITS_9 field "1.13"
			provision "Identifies whether the reporting counterparty has concluded the contract as principal on own account (on own behalf or behalf of a client) or as agent for the account of and on behalf of a client"]
 	return "Out Of Scope"
 		as "Trading Capacity"

reporting rule Quantity <"The number of units of the financial instrument, or the number of derivative contracts in the transaction. The nominal or monetary value of the financial instrument.">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "30"
 	   	provision "The number of units of the financial instrument, or the number of derivative contracts in the transaction.
					The nominal or monetary value of the financial instrument.
					For spread bets, the quantity shall be the monetary value wagered per point movement in the underlying financial instrument.
					For credit default swaps, the quantity shall be the notional amount for which the protection is acquired or disposed of.
					For increase or decrease in notional amount derivative contracts, the number shall reflect the absolute value of the change and shall be expressed as a positive number.
					The information reported in this field shall be consistent with the values provided in fields 33 and 46."]
		[regulatoryReference ESMA EMIR ITS_9 field "2.22"
			provision "Number of contracts included in the report. For spread bets, the quantity shall be the monetary value wagered per point movement in the direct underlying financial instrument."]
 	TradeForEvent then
 	extract Trade -> tradableProduct -> priceQuantity -> quantity -> amount
		as "Quantity"

reporting rule FixedRatePrice
 	TradeForEvent then
		 filter when Trade -> tradableProduct -> priceQuantity -> price -> priceType = PriceTypeEnum -> InterestRate then
		 	extract Trade -> tradableProduct -> priceQuantity -> price -> amount
		   as "Price"

reporting rule FloatingRatePrice
 	TradeForEvent then
	 	filter when Trade -> tradableProduct -> priceQuantity -> observable -> rateOption exists then
	 		extract Trade -> tradableProduct -> priceQuantity -> price -> amount
			as "Price"

reporting rule VenueOfExecution <"Venue of Execution">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "36"
			provision "Identification of the venue where the transaction was executed. Use the ISO 10383 segment MIC for transactions executed on a trading venue, Systematic Internaliser (SI) or organised trading platform outside of the Union. Where the segment MIC does not exist, use the operating MIC. Use MIC code 'XOFF’ for financial instruments admitted to trading, or traded on a trading venue or for which a request for admission was made, where the transaction on that financial instrument is not executed on a trading venue, SI or organised trading platform outside of the Union, or where an investment firm does not know it is trading with another investment firm acting as an SI. Use MIC code 'XXXX’ for financial instruments that are not admitted to trading or traded on a trading venue or for which no request for admission has been made and that are not traded on an organised trading platform outside of the Union but where the underlying is admitted to trading or traded on a trading venue. "]
		[regulatoryReference ESMA EMIR ITS_9 field "2.15"
			provision "The venue of execution of the derivative contract shall be identified by a unique code for this venue. Where a contract was concluded OTC and the respective instrument is admitted to trading or traded on a trading venue, MIC code ‘ XOFF’ shall be used. Where a contract was concluded OTC and the respective instrument is not admitted to trading or traded on a trading venue, MIC code ‘XXXX’ shall be used."]
 	return "XXXX"
 		as "Venue of execution"

reporting rule CountryOfTheBranchMembership <"Country of the branch membership">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "37"
			provision "Code used to identify the country of a branch of the investment firm whose market membership was used to execute the transaction. Where a branch's market membership was not used, this field shall be populated with the country code of the home Member State of the investment firm or the country code of the country where the firm has established its head office or registered office (in the case of third country firms). This field shall only be populated for the market side of a transaction executed on a trading venue or on an organised trading platform outside of the Union."
		]
 	return "Out Of Scope"
 		as "Country Of The Branch Membership"

reporting rule InstrumentIdentificationCode <"Instrument identification code">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "41"
			provision "Code used to identify the financial instrument. This field applies to financial instruments for which a request for admission to trading has been made, that are admitted to trading or traded on a trading venue or on a systematic internaliser. It also applies to financial instruments which have an ISIN and are traded on organised trading platform outside of the Union where the underlying is a financial instrument traded on a trading venue."
		]
 	return "Out Of Scope"
 		as "Instrument Identification Code"

reporting rule InstrumentFullName <"Instrument full name">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "42"
			provision "Full name of the financial instrument"
		]
 	return "Out Of Scope"
 		as "Instrument Full Name"

reporting rule InstrumentClassification <"Instrument classification">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "43"
			provision "Taxonomy used to classify the financial instrument. A complete and accurate CFI code shall be provided."
		]
 	return "Out Of Scope"
 		as "Instrument Classification"

reporting rule NotionalCurrency1 <"Notional currency 1">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "44"
			provision "Currency in which the notional is denominated. In the case of an interest rate or currency derivative contract, this will be the notional currency of leg 1 or the currency 1 of the pair.  In the case of swaptions where the underlying swap is single-currency, this will be the notional currency of the underlying swap. For swaptions where the underlying is multi-currency, this will be the notional currency of leg 1 of the swap. "]
			[regulatoryReference ESMA EMIR ITS_9 field "2.9"
 	   	provision "The currency of the notional amount. In the case of an interest rate or currency derivative contract, this will be the notional currency of leg 1."]
 	return "Out Of Scope"
 		as "Notional Currency 1"

reporting rule NotionalCurrency2 <"Notional currency 2">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "45"
			provision "In the case of multi-currency or cross-currency swaps the currency in which leg 2 of the contract is denominated. For swaptions where the underlying swap is multi-currency, the currency in which leg 2 of the swap is denominated"]
		[regulatoryReference ESMA EMIR ITS_9 field "2.10"
 	   		provision "The currency of the notional amount. In the case of an interest rate or currency derivative contract, this will be the notional currency of leg 1."]
 	return "Out Of Scope"
 		as "Notional Currency 2"

reporting rule PriceMultiplier <"Price multiplier">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "46"
			provision "Number of units of the underlying instrument represented by a single derivative contract. Monetary value covered by a single swap contract where the quantity field indicates the number of swap contracts in the transaction. For a future or option on an index, the amount per index point. For spreadbets the movement in the price of the underlying instrument on which the spreadbet is based. The information reported in this field shall be consistent with the values provided in fields 30 and 33."]
		[regulatoryReference ESMA EMIR ITS_9 field "2.21"
			provision "The number of units of the financial instrument which are contained in a trading lot; for example, the number of derivatives represented by the contract"]
 	return "Out Of Scope"
 		as "Price Multiplier"

reporting rule UnderlyingInstrumentCode <"Underlying instrument code">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "47"
			provision "ISIN code of the underlying instrument.For ADRs, GDRs and similar instruments, the ISIN code of the financial instrument on which those instruments are based.For convertible bonds, the ISIN code of the instrument in which the bond can be converted.For derivatives or other instruments which have an underlying, the underlying instrument ISIN code, when the underlying is admitted to trading, or traded on a trading venue. Where the underlying is a stock dividend, then ISIN code of the related share entitling the underlying dividend.For Credit Default Swaps, the ISIN of the reference obligation shall be provided.In case the underlying is an Index and has an ISIN, the ISIN code for that index.Where the underlying is a basket, include the ISIN of each constituent of the basket that is admitted to trading or is traded on a trading venue. Field 47 shall be reported as many times as necessary to list all reportable instruments in the basket."
		]
 	return "Out Of Scope"
 		as "Underlying Instrument Code"

reporting rule UnderlyingIndexName
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "48"
   	provision "When the underlying is an index, the name of the Index"
   ]
    TradeForEvent then
 	extract Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> equityPayout -> underlier then
 		extract
 			if Underlier exists
			then Underlier -> underlyingProduct -> contractualProduct -> productIdentification -> productIdentifier->identifier
			else "NOAP" 
			as "Underlying Index Name"

reporting rule UnderlyingIndexTermPeriod <"Term of the underlying index period (DAYS, WEEK, MNTH, YEAR)">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "49.1"
			provision "In case the underlying is an index, the term of the index."
		]
 	return "Out Of Scope"
 		as "Underlying Index Term Period"

reporting rule UnderlyingIndexTermMultiplier <"Term of the underlying index (number)">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "49.2"
			provision "In case the underlying is an index, the term of the index."
		]
 	return "Out Of Scope"
 		as "Underlying Index Term Multiplier"

reporting rule ExpiryDate <"Expiry date">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "55"
			provision "Expiry date of the financial instrument. Field only applies to derivatives with a defined expiry date."
		]
 	return "Out Of Scope"
 		as "Expiry Date"

reporting rule DeliveryType <"Delivery type">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "56"
			provision "Indication as to whether the transaction is settled physically or in cash. Where delivery type cannot be determined at time of execution, the value shall be 'OPTL’. The field is only applicable for derivatives."]
		[regulatoryReference ESMA EMIR ITS_9 field "2.24"
			provision "Indicates whether the contract is settled physically or in cash"]
 	return "Out Of Scope"
 		as "Delivery Type"

reporting rule InvestmentDecisionWithinFirm <"Investment decision within firm (Natural persons or Algorithms)">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "57"
			provision "Code used to identify the person or algorithm within the investment firm who is responsible for the investment decision. For natural persons, the identifier specified in Article 6 shall be used If the investment decision was made by an algorithm, the field shall be populated as set out in Article 8. Field only applies for investment decision within the firm. Where the transaction is for a transmitted order that has met the conditions for transmission set out in Article 4, this field shall be populated by the receiving firm within the receiving firm's report using the information received from the transmitting firm."
		]
 	return "Out Of Scope"
 		as "Investment Decision Within Firm"

reporting rule PersonResponsibleForInvestmentDecisionCountry <"Country of the branch supervising the person responsible for the investment decision">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "58"
			provision "Code used to identify the country of the branch of the investment firm for the person responsible for the investment decision, as set out in Article 14(3)(b). Where the person responsible for the investment decision was not supervised by a branch, this field shall be populated with the country code of the home Member State of the investment firm or the country code of the country where the firm has established its head office or registered office (in the case of third country firms). Where the transaction is for a transmitted order that has met the conditions for transmission set out in Article 4, this field shall be populated by the receiving firm within the receiving firm's report using the information received from the transmitting firm. This field is not applicable when the investment decision was made by an algorithm"
		]
 	return "Out Of Scope"
 		as "Person Responsible For Investment Decision Country"

reporting rule ExecutionWithinFirm <"Execution within firm">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "59"
			provision "Code used to identify the person or algorithm within the investment firm who is responsible for the execution. For natural persons, the identifier specified in Article 6 shall be used. If the execution was made by an algorithm, the field shall be populated as set out in Article 9."
		]
 	return "Out Of Scope"
 		as "Execution Within Firm"

reporting rule PersonResponsibleForExecutionCountry <"Country of the branch supervising the person responsible for the execution">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "60"
			provision "Code used to identify the country of the branch of the investment firm for the person responsible for the execution of the transaction, as set out in Article 14(3)(c). Where the person responsible was not supervised by a branch, this field shall be populated with the country code of the home Member State of the investment firm, or the country code of the country where the firm has established its head office or registered office (in the case of third country firms). This field is not applicable when the execution was made by an algorithm."
		]
 	return "Out Of Scope"
 		as "Person Responsible For ExecutionCountry"

reporting rule CommodityDerivativeIndicator <"Commodity derivative indicator">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "64"
			provision "Indication as to whether the transaction reduces risk in an objectively measurable way in accordance with Article 57 of Directive 2014/65/EU. Where the transaction is for a transmitted order that has met the conditions for transmission set out in Article 4, this field shall be populated by the receiving firm in the receiving firm's reports using the information received from the transmitting firm. This field is only applicable for commodity derivative transactions."
		]
 	return "Out Of Scope"
 		as "Commodity Derivative Indicator"

reporting rule SecuritiesFinancingTransactionIndicator <"Securities financing transaction indicator">
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "65"
			provision "'true’ shall be populated where the transaction falls within the scope of activity but is exempted from reporting under Regulation (EU) 2015/2365. 'false’ otherwise."
		]
 	return "Out Of Scope"
 		as "Securities Financing Transaction Indicator"

reporting rule TradeForEvent
 	extract
 		if WorkflowStep -> businessEvent -> primitives -> contractFormation -> after -> trade only exists
	then WorkflowStep -> businessEvent -> primitives -> contractFormation -> after -> trade
	    else if WorkflowStep -> businessEvent -> primitives -> quantityChange -> after -> trade  exists
	 	then WorkflowStep -> businessEvent -> primitives -> quantityChange -> after -> trade
		else WorkflowStep -> businessEvent -> primitives -> contractFormation -> after -> trade
 	as "Contract"

reporting rule RateSpecification
 	extract Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> rateSpecification
 	as "Rate Specification"

reporting rule BuyerSeller
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "7"
			provision "Code used to identify the acquirer of the financial instrument.Where the acquirer is a legal entity, the LEI code of the acquirer shall be used.Where the acquirer is a non-legal entity, the identifier specified in Article 6 shall be used.Where the transaction was executed on a trading venue or on an organised trading platform outside of the Union that utilises a central counterparty (CCP) and where the identity of the acquirer is not disclosed, the LEI code of the CCP shall be used.Where the transaction was executed on a trading venue or on an organised trading platform outside of the Union that does not utilise a CCP and where the identity of the acquirer is not disclosed, the MIC code of the trading venue or of the organised trading platform outside of the Union shall be used.Where the acquirer is an investment firm acting as a systematic internaliser (SI), the LEI code of the SI shall be used.'INTC’ shall be used to designate an aggregate client account within the investment firm in order to report a transfer into or out of that account with an associated allocation to the individual client(s) out of or into that account respectively.In case of options and swaptions, the buyer shall be the counterparty that holds the right to exercise the option and the seller shall be the counterparty that sells the option and receives a premium.In case of futures and forwards other than futures and forwards relating to currencies, the buyer shall be the counterparty buying the instrument and the seller the counterparty selling the instrument.In the case of swaps relating to securities, the buyer shall be the counterparty that gets the risk of price movement of the underlying security and receives the security amount. The seller shall be the counterparty paying the security amount.In the case of swaps related to interest rates or inflation indices, the buyer shall be the counterparty paying the fixed rate. The seller shall be the counterparty receiving the fixed rate. In case of basis swaps (float-to-float interest rate swaps), the buyer shall be the counterparty that pays the spread and the seller the counterparty that receives the spread.In the case of swaps and forwards related to currencies and of cross currency swaps, the buyer shall be the counterparty receiving the currency which is first when sorted alphabetically by ISO 4217 standard and the seller shall be the counterparty delivering this currency.In the case of swap related to dividends, the buyer shall be the counterparty receiving the equivalent actual dividend payments. The seller is the counterparty paying the dividend and receiving the fixed rate.In the case of derivative instruments for the transfer of credit risk except options and swaptions, the buyer shall be the counterparty buying the protection. The seller is the counterparty selling the protection.In case of derivative contract related to commodities, the buyer shall be the counterparty that receives the commodity specified in the report and the seller the counterparty delivering this commodity.In case of forward rate agreements, the buyer shall be the counterparty paying the fixed rate and the seller the counterparty receiving the fixed rate.For an increase in notional, the buyer shall be the same as the acquirer of the financial instrument in the original transaction and the seller shall be the same as the disposer of the financial instrument in the original transaction.For a decrease in notional the buyer shall be the same as the disposer of the financial instrument in the original transaction and the seller shall be the same as the acquirer of the financial instrument in the original transaction."]
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "16"
			provision "Code used to identify the disposer of the financial instrument.Where the disposer is a legal entity, the LEI code of the disposer shall be used.Where the disposer is a non-legal entity, the identifier specified in Article 6 shall be used.Where the transaction was executed on a trading venue or on an organised trading platform outside of the Union that utilises a CCP and where the identity of the disposer is not disclosed, the LEI code of the CCP shall be used.Where the transaction was executed on a trading venue or on an organised trading platform outside of the Union that does not utilise a CCP and where the identity of the disposer is not disclosed, the MIC code of the trading venue or of the organised trading platform outside of the Union shall be used.Where the disposer is an investment firm acting as a SI, the LEI code of the SI shall be used'INTC’ shall be used to designate an aggregate client account within the investment firm in order to report a transfer into or out of that account with an associated allocation to the individual client(s) out of or into that account respectively.In case of options and swaptions, the buyer shall be the counterparty that holds the right to exercise the option and the seller shall be the counterparty that sells the option and receives a premium.In case of futures and forwards other than futures and forwards relating to currencies, the buyer shall be the counterparty buying the instrument and the seller the counterparty selling the instrument.In the case of swaps relating to securities, the buyer shall be the counterparty that gets the risk of price movement of the underlying security and receives the security amount. The seller shall be the counterparty paying the security amount.In the case of swaps related to interest rates or inflation indices, the buyer shall be the counterparty paying the fixed rate. The seller shall be the counterparty receiving the fixed rate. In case of basis swaps (float-to-float interest rate swaps), the buyer shall be the counterparty that pays the spread and the seller the counterparty that receives the spread.In the case of swaps and forwards related to currencies and of cross currency swaps, the buyer shall be the counterparty receiving the currency which is first when sorted alphabetically by ISO 4217 standard and the seller shall be the counterparty delivering this currency.In the case of swap related to dividends, the buyer shall be the counterparty receiving the equivalent actual dividend payments. The seller is the counterparty paying the dividend and receiving the fixed rate.In the case of derivative instruments for the transfer of credit risk except options and swaptions, the buyer shall be the counterparty buying the protection. The seller is the counterparty selling the protection.In case of derivative contracts related to commodities, the buyer shall be the counterparty that receives the commodity specified in the report and the seller the counterparty delivering this commodity.In case of forward rate agreements, the buyer shall be the counterparty paying the fixed rate and the seller the counterparty receiving the fixed rate.For an increase in notional, the seller shall be the same as the disposer in the original transaction.For a decrease in notional the seller shall be the same as the acquirer of the financial instrument in the original transaction."]
	TradeForEvent then
	(
		FixedFloatBuyerSeller,
		FixedFixedBuyerSeller,
		SingleCurrencyBasisSwap,
		CrossCurrencySwapBuyerSeller,
		CreditDefaultSwapBuyerSeller
	)

reporting rule FixedFloatBuyerSeller
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "7"
			rationale_author "DRR"
			rationale "The assumption is that the mention of Inflation in this paragraph relates solely to Fixed-Inflation not all inflation – i.e. this paragraph is about Fixed-anything swaps. Note that there’s no explicit classification for single-currency Fixed-Fixed Swaps at all . We have not addressed these for now."
			structured_provision "The Buyer of a [Single-Currency] Fixed-Float or Fixed-Inflation Swap is by definition the Payer of the  Fixed Rate"
			provision ""]
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "16"
			rationale_author "DRR"
			rationale "The assumption is that the mention of Inflation in this paragraph relates solely to Fixed-Inflation not all inflation – i.e. this paragraph is about Fixed-anything swaps. Note that there’s no explicit classification for single-currency Fixed-Fixed Swaps at all . We have not addressed these for now."
			structured_provision "The Seller of a [Single-Currency] Fixed-Float or Fixed-Inflation Swap is by definition the Receiver of the  Fixed Rate"
			provision ""]
	filter when rule IsFixedFloat then
	filter when Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> rateSpecification -> fixedRate exists then
	(
		InterestRatePayoutPayer then PartyToBuyer,
		InterestRatePayoutReceiver then PartyToSeller
	)

reporting rule InterestRatePayoutPayer
	extract Trade -> tradableProduct then
	(
		extract TradableProduct -> counterparty,
		extract TradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> payerReceiver
	) then
	join key Counterparty -> role foreignKey PayerReceiver -> payer then
	extract Counterparty -> partyReference

reporting rule InterestRatePayoutReceiver
	extract Trade -> tradableProduct then
	(
		extract TradableProduct -> counterparty,
		extract TradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> payerReceiver
	) then
	join key Counterparty -> role foreignKey PayerReceiver -> receiver then
	extract Counterparty -> partyReference

reporting rule FixedFixedBuyerSeller
	filter when rule IsFixedFixed then
	filter when Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> payoutQuantity exists then 
	(
		InterestRatePayoutPayer then PartyToBuyer,
		InterestRatePayoutReceiver then PartyToSeller
	)

reporting rule PartyToBuyer
	(
		filter when Party -> partyId -> scheme = "iso17442" then
		extract Party -> partyId as "Buyer identification code"
		,
		filter when Party -> partyId -> scheme = "iso17442" then
		lookup ExecutingEntity ExecutingEntity then
		extract ExecutingEntity -> addressOfBranch -> country
		as "Country of the branch for the buyer"
	)

reporting rule PartyToSeller
	(
		filter when Party -> partyId -> scheme = "iso17442" then
		extract Party -> partyId as "Seller identification code"
		,
		filter when Party -> partyId -> scheme = "iso17442" then
		lookup ExecutingEntity ExecutingEntity then
		extract ExecutingEntity -> addressOfBranch -> country
		as "Country of the branch for the seller"
	)

reporting rule IsFixedFloat
	extract Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> rateSpecification -> fixedRate count = 1
	and Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> rateSpecification -> floatingRate count = 1

reporting rule IsFixedFixed
	extract Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> rateSpecification -> fixedRate count = 2

reporting rule SingleCurrencyBasisSwap
        [regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "7"
            rationale_author "DRR"
            rationale "In case of basis swaps (float-to-float interest rate swaps), the buyer shall be the counterparty that pays the spread."
            structured_provision "The Buyer of a [Single-Currency] Basis Swap is by definition the Payer of the  Spread"
            provision ""]
        [regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "16"
            rationale_author "DRR"
            rationale "In case of basis swaps (float-to-float interest rate swaps), the seller the counterparty that receives the spread."
            structured_provision "The Seller of a [Single-Currency] Basis Swap is by definition the Receiver of the  Spread"
            provision ""]
	filter when rule IsIRSwapBasis then
	filter when Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> rateSpecification -> floatingRate -> rateOption = Trade -> tradableProduct -> priceQuantity -> observable -> rateOption then
	(
		InterestRatePayoutPayer then PartyToBuyer,
		InterestRatePayoutReceiver then PartyToSeller
	)

reporting rule IsIRSwapBasis
	extract Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> rateSpecification -> floatingRate count = 2

reporting rule CrossCurrencySwapBuyerSeller
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "7"
			rationale_author "DRR"
			rationale "The cross-currency nature takes precedence over any permutation of interest types"
			structured_provision "The Buyer of a Cross-Currency Swap is by definition the Receiver of the ISO 4217 currency which is first when sorted ascending irrespective of the interest type or spread"
			provision "The buyer shall be the counterparty receiving the currency which is first when sorted alphabetically by ISO 4217 standard."]
		[regulatoryReference ESMA MiFIR RTS_22 annex "I" table "2" field "16"
			rationale_author "DRR"
			rationale "The cross-currency nature takes precedence over any permutation of interest types"
			structured_provision "The Seller of a Cross-Currency Swap is by definition the Payer of the ISO 4217 currency which is first when sorted ascending irrespective of the interest type or spread"
			provision "The seller shall be the counterparty delivering this currency which is first when sorted alphabetically by ISO 4217 standard."]
	filter when rule IsXCCYSwap then
	minBy rule MinCCYForTrade then
	(
		InterestRatePayoutPayer then PartyToBuyer,
		InterestRatePayoutReceiver then PartyToSeller
	)
	
reporting rule MinCCYForTrade
	extract Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> payoutQuantity -> quantitySchedule -> initialQuantity -> unitOfAmount -> currency then
	minBy itself
	

reporting rule IsXCCYSwap
	extract Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> interestRatePayout -> crossCurrencyTerms -> principalExchanges exists

reporting rule CreditDefaultSwapBuyerSeller
	filter when rule IsCreditDefaultSwap then
	(
		CreditDefaultPayoutBuyer then PartyToBuyer,
		CreditDefaultPayoutSeller then PartyToSeller
	)

reporting rule IsCreditDefaultSwap
	extract Trade -> tradableProduct -> product -> contractualProduct -> economicTerms -> payout -> creditDefaultPayout exists

reporting rule CreditDefaultPayoutBuyer
	extract Trade -> tradableProduct then
	(
		extract TradableProduct -> counterparty,
		extract TradableProduct -> product -> contractualProduct -> economicTerms -> payout -> creditDefaultPayout -> generalTerms -> buyerSeller
	) then
	join key Counterparty -> role foreignKey BuyerSeller -> buyer then
	extract Counterparty -> partyReference

reporting rule CreditDefaultPayoutSeller
	extract Trade -> tradableProduct then
	(
		extract TradableProduct -> counterparty,
		extract TradableProduct -> product -> contractualProduct -> economicTerms -> payout -> creditDefaultPayout -> generalTerms -> buyerSeller
	) then
	join key Counterparty -> role foreignKey BuyerSeller -> seller then
	extract Counterparty -> partyReference

reporting rule Price
		[regulatoryReference ESMA MiFIR RTS_22 annex "1" table "2" field "33"
 	   		provision "For credit default swaps (CDS) it shall be the coupon in basis points. The information reported in this field shall be consistent with the values provided in fields 30 and 46."]
		[regulatoryReference ESMA EMIR ITS_9 field "2.17"
			provision "The price per derivative excluding, where applicable, commission and accrued interest."]
	TradeForEvent then
	(
		FixedFixedPrice,
		FixedFloatPrice,
		BasisSwapPrice,
		CDSPrice
	)

reporting rule FixedFloatPrice
		[regulatoryReference ESMA MiFIR Q_AND_A_MiFIR_DATA_REPORTING section "16" question "2"
			rationale_author "DRR"
			rationale "The Regulations don’t mention this but the Q&A defines it."
	 	   	structured_provision "The regulatoryPrice of a Fixed-Float or Fixed-Inflation Swap is by definition the highest Fixed Rate"
	 	   	provision "Questions and Answers On MiFIR data reporting. Section 14 Financial instruments’ volatile attributes [Last update: 05/10/2017]. Question 1; Answer 1 (a) Where a swap rate or forward rate financial contract is quoted as the fixed rate and it is considered to be an attribute of the transaction rather than an attribute of the financial instrument, the respective reports should be completed as follows: Transaction report - the price (field 33) of the transaction should be populated with the fixed rate value. Question 2; Example 1: CFI code SRC*S* fixed-floating with single currency"]
	filter when rule IsFixedFloat then

		extract Trade -> tradableProduct -> priceQuantity -> price then
		filter when Price -> priceType = PriceTypeEnum -> InterestRate then
		maxBy Price -> amount then
		extract Price -> amount as "Price"

reporting rule BasisSwapPrice
		[regulatoryReference ESMA MiFIR RTS_22 annex "1" table "2" field "33"
			rationale_author "DRR"
			rationale "We also need to cater for the edge case of spreads on both legs. Assume –ve spreads uncommon enough not to need to debate highest positive spread vs highest absolute spread at this point."
	 	   	structured_provision "The regulatoryPrice of a Basis or Float-Inflation Swap is by definition the highest Spread"
	 	   	provision "09April 2019|ESMA70-1861941480-56. Questions and Answers On MiFIR data reporting. Section 16 Interest Rate Swaps reporting [Last update: 26/09/2018]. Question 2 Answer 2 CFI SRA*S*, Tenor basis swap (float-to-float single currency). 10 Years EUR EURIBOR 3 months + 2 basis points VS EURIBOR 6 MONTHS. 33 Price 2: If the spread was negative i.e. Firm X was paying 3 month EUR EURIBOR - 2 basis points then Firm X should still be reported as the buyer but the price would be reported as '-2’ in the reports of X and Y."]
	filter when rule IsIRSwapBasis then
	filter when Trade -> tradableProduct -> priceQuantity -> observable -> rateOption exists then
	extract Trade -> tradableProduct -> priceQuantity -> price -> amount as "Price"

reporting rule FixedFixedPrice
	filter when rule IsFixedFixed then
	filter when Trade -> tradableProduct -> priceQuantity -> price -> priceType = PriceTypeEnum -> InterestRate then
		extract Trade -> tradableProduct -> priceQuantity -> price then
		maxBy Price -> amount then
		extract Price -> amount as "Price"

reporting rule CDSPrice
		[regulatoryReference ESMA MiFIR RTS_22 annex "1" table "2" field "33"
			rationale_author "DRR"
			rationale "Coupon refers to the Fixed Rate. However market practice is to have either/both a Fixed Rate and/or a spread on the Floating Rate."
	 	   	structured_provision "Of a Credit Default Swap is by definition the Fixed Rate unless the Fixed Rate is Zero and there is a Spread then the regulatoryPrice is by definition the Spread"
	 	   	provision "For credit default swaps (CDS) it shall be the coupon in basis points. "]
	filter when rule IsCreditDefaultSwap then
	extract Trade -> tradableProduct -> priceQuantity then
	if 
		filter when PriceQuantity -> price -> priceType = PriceTypeEnum -> InterestRate
			and PriceQuantity -> price -> amount <> 0
			do extract PriceQuantity -> price -> amount as "Price"
		else if
		 filter when PriceQuantity -> price -> priceType = PriceTypeEnum -> Spread
			do extract PriceQuantity -> price -> amount as "Price"
		else do
		 return 0 as "Price"
	endif
/*
extract multiple Trade -> tradableProduct -> priceQuantity -> price then
		filter when Price -> priceType = PriceTypeEnum -> InterestRate then
		maxBy Price -> amount then
		extract Price -> amount as "Price"
*/
type ExecutingEntity:
	isInvestmentFirm boolean (1..1)
	addressOfBranch Address (1..1)
	addressOfIncorporation Address (1..1)

eligibility rule IsAddressInEEA
extract
	Address -> country = "FI" or
	Address -> country = "AT" or
	Address -> country = "PT" or
	Address -> country = "BE" or
	Address -> country = "BG" or
	Address -> country = "ES" or
	Address -> country = "HR" or
	Address -> country = "CY" or
	Address -> country = "CZ" or
	Address -> country = "DK" or
	Address -> country = "EE" or
	Address -> country = "FI" or
	Address -> country = "FR" or
	Address -> country = "GF" or
	Address -> country = "DE" or
	Address -> country = "GI" or
	Address -> country = "GR" or
	Address -> country = "GP" or
	Address -> country = "GG" or
	Address -> country = "HU" or
	Address -> country = "IS" or
	Address -> country = "IE" or
	Address -> country = "IM" or
	Address -> country = "IT" or
	Address -> country = "JE" or
	Address -> country = "LV" or
	Address -> country = "LI" or
	Address -> country = "LT" or
	Address -> country = "LU" or
	Address -> country = "PT" or
	Address -> country = "MT" or
	Address -> country = "MQ" or
	Address -> country = "YT" or
	Address -> country = "NL" or
	Address -> country = "NO" or
	Address -> country = "PL" or
	Address -> country = "PT" or
	Address -> country = "RE" or
	Address -> country = "RO" or
	Address -> country = "BL" or
	Address -> country = "MF" or
	Address -> country = "PM" or
	Address -> country = "SK" or
	Address -> country = "SI" or
	Address -> country = "ES" or
	Address -> country = "SE" or
	Address -> country = "GB"

eligibility rule IsAddressInEU
extract
	Address -> country = "AT" or
	Address -> country = "BE" or
	Address -> country = "BG" or
	Address -> country = "CY" or
	Address -> country = "CZ" or
	Address -> country = "DE" or
	Address -> country = "DK" or
	Address -> country = "EE" or
	Address -> country = "ES" or
	Address -> country = "FI" or
	Address -> country = "FR" or
	Address -> country = "GB" or
	Address -> country = "GR" or
	Address -> country = "HR" or
	Address -> country = "HU" or
	Address -> country = "IE" or
	Address -> country = "IT" or
	Address -> country = "LT" or
	Address -> country = "LU" or
	Address -> country = "LV" or
	Address -> country = "MT" or
	Address -> country = "NL" or
	Address -> country = "PO" or
	Address -> country = "PT" or
	Address -> country = "RO" or
	Address -> country = "SE" or
	Address -> country = "SI" or
	Address -> country = "SK"

reporting rule ReportingTimestamp <"Reporting Timestamp">
	[regulatoryReference ESMA EMIR ITS_9 field "1.1"
 	   	provision "Date and time of reporting to the trade repository"]
	extract WorkflowStep->timestamp->dateTime
			as "Reporting Timestamp"

reporting rule TypeOfIdOfTheOtherCounterparty <"Type of ID of the other Counterparty">
	[regulatoryReference ESMA EMIR ITS_9 field "1.3"
 	   	provision "Type of ID of the other Counterparty"]
	return "Not Modelled"
			as "Type of ID of the other Counterparty"

reporting rule IdOfTheOtherCounterparty <"ID of the other Counterparty">
	[regulatoryReference ESMA EMIR ITS_9 field "1.4"
 	   	provision "ID of the other Counterparty"]
	return "Not Modelled"
			as "ID of the other Counterparty"

reporting rule CountryOfTheOtherCounterparty <"Country of the other Counterparty">
	[regulatoryReference ESMA EMIR ITS_9 field "1.5"
 	   	provision "Country of the other Counterparty"]
	return "Not Modelled"
			as "Country of the other Counterparty"

reporting rule CorporateSectorOfTheReportingCounterparty <"Corporate sector of the reporting counterparty">
	[regulatoryReference ESMA EMIR ITS_9 field "1.6"
 	   	provision "Nature of the reporting counterparty's company activities. If the Reporting Counterparty is a Financial Counterparty, this field shall contain all necessary codes included in the Taxonomy for Financial Counterparties and applying to that Counterparty. If the Reporting Counterparty is a Non-Financial Counterparty, this field shall contain all necessary codes included in the Taxonomy for Non-Financial Counterparties and applying to that Counterparty. Where more than one activity is reported, the codes shall be populated in order of the relative importance of the corresponding activities."]
	return "Not Modelled"
			as "Corporate sector of the reporting counterparty"

reporting rule NatureOfTheReportingCounterparty <"Nature of the reporting counterparty">
	[regulatoryReference ESMA EMIR ITS_9 field "1.7"
 	   	provision "Indicate if the reporting counterparty is a CCP, a financial, non-financial counterparty or other type of counterparty in accordance with point 5 of Article 1 or points 1, 8 and 9 of Article 2 of Regulation (EU) No 648/2012 of the European Parliament and of the Council."]
	return "Not Modelled"
			as "Nature of the reporting counterparty"

reporting rule BrokerID <"Broker ID">
	[regulatoryReference ESMA EMIR ITS_9 field "1.8"
 	   	provision "In the case a broker acts as intermediary for the reporting counterparty without becoming a counterparty himself, the reporting counterparty shall identify this broker by a unique code"]
	return "Not Modelled"
			as "Broker ID"

reporting rule TypeOfIdOfTheBeneficiary <"Type of ID of the Beneficiary">
	[regulatoryReference ESMA EMIR ITS_9 field "1.11"
 	   	provision "Type of the code used to identify the Beneficiary"]
	return "Not Modelled"
			as "Type of ID of the Beneficiary"

reporting rule BeneficiaryID <"Beneficiary ID">
	[regulatoryReference ESMA EMIR ITS_9 field "1.12"
 	   	provision "The party subject to the rights and obligations arising from the contract. Where the transaction is executed via a structure, such as a trust or fund, representing a number of beneficiaries, the beneficiary should be identified as that structure. Where the beneficiary of the contract is not a counterparty to this contract, the reporting counterparty has to identify this beneficiary by an unique code or, in case of a private individuals, by a client code used in a consistent manner as assigned by the legal entity used by the private individual."]
	return "Not Modelled"
			as "Beneficiary ID"

reporting rule CounterpartySide <"Counterparty Side">
	[regulatoryReference ESMA EMIR ITS_9 field "1.14"
 	   	provision "Identifies whether the reporting counterparty is a buyer or a seller"]
	return "Not Modelled"
			as "Counterparty Side"

reporting rule DirectlyLinkedToCommercialActivityOrTreasuryFinancing <"Directly linked to commercial activity or treasury financing">
	[regulatoryReference ESMA EMIR ITS_9 field "1.15"
 	   	provision "Information on whether the contract is objectively measurable as directly linked to the reporting counterparty's commercial or treasury financing activity, as referred to in Art. 10(3) of Regulation (EU) No 648/2012. This field shall be left blank in the case where the reporting counterparty is a financial counterparty, as referred to in Article 2 (8) Regulation of (EU) No 648/2012."]
	return "Not Modelled"
			as "Directly linked to commercial activity or treasury financing"

reporting rule ClearingThreshold <"Clearing threshold">
	[regulatoryReference ESMA EMIR ITS_9 field "1.16"
 	   	provision "Information whether the reporting counterparty is above the clearing threshold referred to in Art. 10(3) of Regulation (EU) No 648/2012. This field shall be left blank in case the reporting counterparty is a financial counterparty, as referred to in Art. 2 (8) of Regulation (EU) No 648/2012."]
	return "Not Modelled"
			as "Clearing threshold"

reporting rule ContractType <"Contract Type">
	[regulatoryReference ESMA EMIR ITS_9 field "2.1"
 	   	provision "Each reported contract shall be classified according to its type."]
	return "Not Modelled"
			as "Contract Type"

reporting rule AssetClass <"Asset Class">
	[regulatoryReference ESMA EMIR ITS_9 field "2.2"
 	   	provision "Each reported contract shall be classified according to the asset class it is based on."]
	return "Not Modelled"
			as "Asset Class"

reporting rule ProductClassificationType <"Product classification type">
	[regulatoryReference ESMA EMIR ITS_9 field "2.3"
 	   	provision "The type of relevant product classification."]
	return "Not Modelled"
			as "Product classification type"

reporting rule ProductClassification <"Product classification">
	[regulatoryReference ESMA EMIR ITS_9 field "2.4"
 	   	provision "For products identified through International Securities Identification Number (ISIN) or Alternative Instrument Identifier (AII), Classification of Financial Instrument (CFI) code shall be specified.  For products for which ISIN or AII are not available, endorsed Unique Product Identifier (UPI) shall be specified. Until UPI is endorsed those products shall be classified with CFI code.."]
	return "Not Modelled"
			as "Product classification"

reporting rule ProductIdentificationType <"Product identification type">
	[regulatoryReference ESMA EMIR ITS_9 field "2.5"
 	   	provision "The type of relevant product identification"]
	return "Not Modelled"
			as "Product identification type"

reporting rule ProductIdentification <"Product identification">
	[regulatoryReference ESMA EMIR ITS_9 field "2.6"
 	   	provision "The product shall be identified through ISIN or AII. AII shall be used if a product is traded in a trading venue classified as AII in the register published on ESMA's website and set up on the basis of information provided by competent authoriities pursuant to Article 13(2) of Commission Regulation (EC) No 1287/2006. AII shall only be used until the date of application of the delegated act adopted by the Commission pursuant to Article 27(3) of Regulation (EU) No 600/2014 of the European Parliament and Council."]
	return "Not Modelled"
			as "Product identification"

reporting rule UnderlyingIdentificationType <"Underlying identification Type">
	[regulatoryReference ESMA EMIR ITS_9 field "2.7"
 	   	provision "The type of relevant underlying identifier"]
	return "Not Modelled"
			as "Underlying identification Type"

reporting rule UnderlyingIdentification <"Underlying identification">
	[regulatoryReference ESMA EMIR ITS_9 field "2.8"
 	   	provision "The direct underlying shall be identified by using a unique identification for this underlying based on its type. AII shall only be used until the date of application of the delegated act adopted by the Commission pursuant to Article 27(3) of Regulation (EU) No 600/2014. For Credit Default Swaps, the ISIN of the reference obligation should be provided. In case of baskets composed, among others, of financial instruments traded in a trading venue, only financial instruments traded in a trading venue shall be specified."]
	return "Not Modelled"
			as "Underlying identification"

reporting rule DeliverableCurrency <"Deliverable currency">
	[regulatoryReference ESMA EMIR ITS_9 field "2.11"
 	   	provision "The currency to be delivered"]
	return "Not Modelled"
			as "Deliverable currency"

reporting rule Compression <"Compression">
	[regulatoryReference ESMA EMIR ITS_9 field "2.16"
		provision "Identify whether the contract results from a compression operation as defined in Article 2(1)(47) of Regulation (EU) No 600/2014."]
	return "Not Modelled"
			as "Compression"

reporting rule PriceNotation <"Price Notation">
	[regulatoryReference ESMA EMIR ITS_9 field "2.18"
		provision "The manner in which the price is expressed."]
	return "Not Modelled"
			as "Price Notation"

reporting rule CurrencyOfPrice <"Currency of price">
	[regulatoryReference ESMA EMIR ITS_9 field "2.19"
		provision "The currency in which the Price / rate is denominated."]
	return "Not Modelled"
			as "Currency of price"

reporting rule Notional <"Notional">
	[regulatoryReference ESMA EMIR ITS_9 field "2.20"
		provision "The reference amount from which contractual payments are determined. In case of partial terminations, amortisations and in case of contracts where the notional, due to the characteristics of the contract, varies over time, it shall reflect the remaining notional after the change took place."]
	return "Not Modelled"
			as "Notional"

reporting rule UpfrontPayment <"Up-front payment">
	[regulatoryReference ESMA EMIR ITS_9 field "2.23"
		provision "Amount of any up-front payment the reporting counterparty made or received."]
	return "Not Modelled"
			as "Up-front payment"

reporting rule ExecutionTimestamp <"Execution timestamp">
	[regulatoryReference ESMA EMIR ITS_9 field "2.25"
		provision "Date and time when the contract was executed."]
	return "Not Modelled"
			as "Execution timestamp"

reporting rule EffectiveDate <"Effective Date">
	[regulatoryReference ESMA EMIR ITS_9 field "2.26"
		provision "Date when obligations under the contract come into effect"]
	return "Not Modelled"
			as "Effective Date"

reporting rule TerminationDate <"Termination Date">
	[regulatoryReference ESMA EMIR ITS_9 field "2.28"
		provision "Termination date in the case of an early termination of the reported contract."]
	return "Not Modelled"
			as "Termination Date"

reporting rule SettlementDate <"Settlement Date">
	[regulatoryReference ESMA EMIR ITS_9 field "2.29"
		provision "Date of settlement of the underlying. If more than one, further fields may be used."]
	return "Not Modelled"
			as "Settlement Date"

reporting rule MasterAgreementType <"Master Agreement Type">
	[regulatoryReference ESMA EMIR ITS_9 field "2.30"
		provision "Reference to any master agreement, if existent (e.g. ISDA Master Agreement; Master Power Purchase and Sale Agreement; International ForEx Master Agreement; European Master Agreement or any local Master Agreements)."]
	return "Not Modelled"
			as "Master Agreement Type"

reporting rule MasterAgreementVersion <"Master Agreement Version">
	[regulatoryReference ESMA EMIR ITS_9 field "2.31"
		provision "Reference to the year of the master agreement version used for the reported trade, if applicable (e.g. 1992, 2002, etc.)"]
	return "Not Modelled"
			as "Master Agreement Version"

reporting rule ConfirmationTimestamp <"Confirmation timestamp">
	[regulatoryReference ESMA EMIR ITS_9 field "2.32"
		provision "Date and time of the confirmation, as set out in Article 12 of Commission Delegated Regulation (EU) No 149/2013"]
	return "Not Modelled"
			as "Confirmation timestamp"

reporting rule ConfirmationMeans <"Confirmation means">
	[regulatoryReference ESMA EMIR ITS_9 field "2.33"
		provision "Whether the contract was electronically confirmed, non-electronically confirmed or remains unconfirmed"]
	return "Not Modelled"
			as "Confirmation means"

reporting rule Cleared <"Cleared">
	[regulatoryReference ESMA EMIR ITS_9 field "2.35"
		provision "Indicates, whether clearing has taken place"]
        extract if WorkflowStep -> businessEvent -> eventQualifier = "ClearedTrade" then "Y"
            else if WorkflowStep -> businessEvent -> eventQualifier <> "ClearedTrade" then "N"
            else "" as "Cleared"

reporting rule Intragroup <"Intragroup">
	[regulatoryReference ESMA EMIR ITS_9 field "2.38"
		provision "Indicates whether the contract was entered into as an intragroup transaction, defined in Article 3 of Regulation (EU) No 648/2012"]
	return "Not Modelled"
			as "Intragroup"

reporting rule ExchangeRate1 <"Exchange rate 1">
	[regulatoryReference ESMA EMIR ITS_9 field "2.62"
		provision "The exchange rate as of the date and time when the contract was concluded. It shall be expressed as a price of base currency in the quoted currency."]
	return "Not Modelled"
			as "Exchange rate 1"

reporting rule ForwardExchangeRate <"Forward exchange rate">
	[regulatoryReference ESMA EMIR ITS_9 field "2.63"
		provision "Forward exchange rate as agreed between the counterparties in the contractual agreement It shall be expressed as a price of base currency in the quoted currency."]
	return "Not Modelled"
			as "Forward exchange rate"

reporting rule ExchangeRateBasis <"Exchange rate basis">
	[regulatoryReference ESMA EMIR ITS_9 field "2.64"
		provision "Quote base for exchange rate"]
	return "Not Modelled"
			as "Exchange rate basis"

reporting rule OptionType <"Option type">
	[regulatoryReference ESMA EMIR ITS_9 field "2.78"
		provision "Indication as to whether the derivative contract is a call (right to purchase a specific underlying asset) or a put (right to sell a specific underlying asset) or whether it cannot be determined whether it is a call or a put at the time of execution of the derivative contract.
			In case of swaptions it shall be:
				- “Put”, in case of receiver swaption, in which the buyer has the right to enter into a swap as a fixed-rate receiver.
				-“Call”, in case of payer swaption, in which the buyer has the right to enter into a swap as a fixed-rate payer.
			In case of Caps and Floors it shall be:
				-“Put”, in case of a Floor.
				-“Call”, in case of a Cap."]
	return "Not Modelled"
			as "Option type"

reporting rule OptionExerciseStyle <"Option exercise style">
	[regulatoryReference ESMA EMIR ITS_9 field "2.79"
		provision "Indicates whether the option may be exercised only at a fixed date (European, and Asian style), a series of pre-specified dates (Bermudan) or at any time during the life of the contract (American style)"]
	return "Not Modelled"
			as "Option exercise style"

reporting rule StrikePrice <"Strike price (cap/floor rate)">
	[regulatoryReference ESMA EMIR ITS_9 field "2.80"
		provision "The strike price of the option."]
	return "Not Modelled"
			as "Strike price (cap/floor rate)"

reporting rule StrikePriceNotation <"Strike price notation">
	[regulatoryReference ESMA EMIR ITS_9 field "2.81"
		provision "The manner in which the strike price is expressed"]
	return "Not Modelled"
			as "Strike price notation"

reporting rule ActionType <"Action type">
	[regulatoryReference ESMA EMIR ITS_9 field "2.93"
		provision "Whether the report contains:
					— a derivative contract for the first time, in which case it will be identified as ‘new’;
					— a modification to the terms or details of a previously reported derivative contract, but not a correction of a report, in which case it will be identified as ‘modify’. This includes an update to a previous report that is showing a position in order to reflect new trades included in that position.;
					— a cancellation of a wrongly submitted entire report in case the contract never came into existence or was not subject to Regulation (EU) No 648/ 2012 reporting requirements but was reported to a Trade Repository by mistake, in which case, it will be identified as ‘error’;
					— an early termination of an existing contract, in which case it will be identified as ‘early termination’;
					- a previously submitted report contains erroneous data fields, in which case the report correcting the erroneous data fields of the previous report shall be identified as ‘correction’;
					— a compression of the reported contract, in which case it will be identified as ‘compression’;
					— an update of a contract valuation or collateral, in which case it will be identified as ‘valuation update’;
					— a derivative contract that is to be reported as a new trade and also included in a separate position report on the same day, in which case it will be identified as a ‘position component’. This value will be equivalent to reporting a new trade followed by an update to that report showing it as compressed."]
	return "Not Modelled"
			as "Action type"

reporting rule Level <"Level">
	[regulatoryReference ESMA EMIR ITS_9 field "2.94"
		provision "Indication whether the report is done at trade or position level. Position level report can be used only as a supplement to trade level reporting to report post-trade events and only if individual trades in fungible products have been replaced by the position."]
	return "Not Modelled"
			as "Level"

