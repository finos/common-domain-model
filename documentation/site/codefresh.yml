version: "1.0"
build_version: "v2"
steps:
  CheckoutAllRepos:
    title: Prepare files for sphinx
    image: regnosys-docker-registry.jfrog.io/regnosys/utils:latest
    working_directory: "."
    commands:
      - ls -alF .
      - export LATEST_RELEASE_ID=${{TAG_NAME}}
      - echo "Release id is $LATEST_RELEASE_ID"
      - rm -rf rosetta-docs/ rosetta-dsl/ rosetta-code-generators/ rosetta-cdm/ rosetta-products/
      - git clone -b ${{CF_BRANCH}} --single-branch https://${{REGNOSYS_OPS}}:${{REGNOSYS_OPS_TOKEN}}@github.com/REGnosys/rosetta-docs
      - bash rosetta-docs/checkout.sh "" "" rosetta-dsl ${{CF_BRANCH}}
      - bash rosetta-docs/checkout.sh "" "" rosetta-code-generators ${{CF_BRANCH}}
      - bash rosetta-docs/checkout.sh ${{REGNOSYS_OPS}} ${{REGNOSYS_OPS_TOKEN}} rosetta-cdm ${{CF_BRANCH}}
      - bash rosetta-docs/checkout.sh ${{REGNOSYS_OPS}} ${{REGNOSYS_OPS_TOKEN}} rosetta-products ${{CF_BRANCH}}
      - printf "Copying CDM artefacts... \n"
      - mkdir -p rosetta-docs/cdm/documentation/source
      - find rosetta-cdm/rosetta-source/documentation/source/ -name *.png -exec cp "{}" rosetta-docs/cdm/documentation/source/ \;
      - cp rosetta-cdm/rosetta-source/documentation/source/documentation.rst rosetta-docs/cdm/documentation/source/documentation.rst
      - cp rosetta-cdm/rosetta-source/documentation/source/eligible-collateral-representation.rst rosetta-docs/cdm/documentation/source/eligible-collateral-representation.rst
      - cp rosetta-cdm/rosetta-source/documentation/source/cdm-guidelines.rst rosetta-docs/cdm/documentation/source/cdm-guidelines.rst
      - cp rosetta-cdm/rosetta-source/documentation/source/documentation-style-guide.rst rosetta-docs/cdm/documentation/source/documentation-style-guide.rst
      - cp rosetta-cdm/rosetta-source/README.rst rosetta-docs/cdm/readme.rst
      - cp rosetta-cdm/rosetta-source/CONTRIBUTING.rst rosetta-docs/cdm/contributing.rst
      - cp -r rosetta-cdm/rosetta-source/documentation/source/code-snippets rosetta-docs/cdm/documentation/source
      - ls -l rosetta-docs/cdm/documentation/source/code-snippets
      - envsubst \$LATEST_RELEASE_ID < rosetta-docs/cdm/releases/latest-template.rst >  rosetta-docs/cdm/releases/latest.rst
      - printf "Retrieving latest release info... \n"
      - export LATEST_URL=${{CORE_URL}}/api/scm/releases/latest
      - echo "... get latest url is $LATEST_URL"
      - curl -sX GET "$LATEST_URL" > rosetta-docs/latest.json
      - jq ' .bodyAsHtml' rosetta-docs/latest.json > rosetta-docs/latest.txt
      - sed -i 's/^.//;s/.$//' rosetta-docs/latest.txt
      - sed -i 's/\\\"/"/g' rosetta-docs/latest.txt
      - sed -i 's/\\n//g' rosetta-docs/latest.txt
      - cat rosetta-docs/latest.txt
      - cp rosetta-docs/latest.txt rosetta-docs/cdm/releases/latest.html
      - printf "Retrieving all release info... \n"
      - export ALL_URL=${{CORE_URL}}/api/scm/releases/all
      - echo "... get all url is $ALL_URL"
      - curl -sX GET "$ALL_URL" > rosetta-docs/all.json
      - jq  '.[] | "<h4>" + .tag + "</h4>", .bodyAsHtml' rosetta-docs/all.json > rosetta-docs/all.txt
      - sed -i 's/^.//;s/.$//' rosetta-docs/all.txt
      - sed -i 's/\\\"/"/g' rosetta-docs/all.txt
      - sed -i 's/\\n//g' rosetta-docs/all.txt
      - cp rosetta-docs/all.txt rosetta-docs/cdm/releases/all.html
      - printf "Copying DSL artefacts... \n"
      - mkdir -p rosetta-docs/dsl/images
      - cp rosetta-dsl/README.rst rosetta-docs/dsl/readme.rst
      - cp rosetta-dsl/documentation/documentation.rst rosetta-docs/dsl/documentation.rst
      - cp rosetta-code-generators/README.rst rosetta-docs/dsl/codegen-readme.rst
      - cp rosetta-code-generators/images/rosetta-language-code-generation.png rosetta-docs/dsl/images/rosetta-language-code-generation.png
      - printf "Copying Rosetta Core artefacts... \n"
      - mkdir -p rosetta-docs/core/images
      - cp -r rosetta-products/documentation/images rosetta-docs/core
      - cp rosetta-products/documentation/0-welcome-to-rosetta.rst rosetta-docs/core/0-welcome-to-rosetta.rst
      - cp rosetta-products/documentation/1-workspace.rst rosetta-docs/core/1-workspace.rst
      - cp rosetta-products/documentation/2-rosetta-design.rst rosetta-docs/core/2-rosetta-design.rst
      - cp rosetta-products/documentation/3-rosetta-translate.rst rosetta-docs/core/3-rosetta-translate.rst
      - cp rosetta-products/documentation/4-api-export.rst rosetta-docs/core/4-api-export.rst
      - cp rosetta-products/documentation/5-status-page.rst rosetta-docs/core/5-status-page.rst
      - cp rosetta-products/documentation/6-rosetta-tutorial.rst rosetta-docs/core/6-rosetta-tutorial.rst
      - cp rosetta-products/documentation/7-rosetta-engine.rst rosetta-docs/core/7-rosetta-engine.rst

  BuildDocsDockerImage:
    title: Build Docs Docker Image
    no_cache: true
    no_cf_cache: true
    image_name: regnosys/rosetta-docs
    type: build
    working_directory: ./rosetta-docs
    dockerfile: Dockerfile
    tag: ${{TAG_NAME}}
    registry: regnosys-docker-registry
    when:
      condition:
        all:
          buildPassed: steps.CheckoutAllRepos.result == 'success'

  DeployDocsRCServer:
    title: Deploy rc Server Image
    type: deploy
    kind: kubernetes
    cluster: "rosetta-cluster@Release Candidate"
    namespace: rosetta-docs-rc
    service: rosetta-docs
    candidate:
      image: "${{BuildDocsDockerImage}}"
      registry: regnosys-docker-registry
    when:
      condition:
        all:
          ready: steps.BuildDocsDockerImage.result == 'success'

  TagRepo:
    title: Tag git repo with release name
    image: alpine/git
    when:
      condition:
        all:
          builds_successful: steps.BuildDocsDockerImage.result =='success' && steps.DeployDocsRCServer.result == 'success'
          isNewRelease: "${{TAG_REPO}}"
    commands:
      - ls -alF .
      - cd rosetta-docs
      - printf "This is a release candidate build, tag repos with release name [${{TAG_NAME}}] \n"
      - git fetch --prune https://${{REGNOSYS_OPS}}:${{REGNOSYS_OPS_PWD}}@github.com/REGnosys/rosetta-docs.git "+refs/tags/*:refs/tags/*"
      - git tag ${{TAG_NAME}}
      - git push https://${{REGNOSYS_OPS}}:${{REGNOSYS_OPS_PWD}}@github.com/REGnosys/rosetta-docs.git ${{TAG_NAME}}
